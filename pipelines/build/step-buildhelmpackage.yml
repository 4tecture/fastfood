parameters:
- name: artifactStagingDirectory
  type: string
  default:
- name: artifactName
  type: string
  default: 
- name: helmVersion
  type: string
  default: latest
- name: kubectlVersion
  type: string
  default: latest
- name: chartPath
  type: string
  default: 
- name: chartVersion
  type: string
  default: '$(Build.BuildNumber)'
- name: installHelm
  type: boolean
  default: true
- name: installKubectl
  type: boolean
  default: true

steps:
- ${{ if eq(parameters.installKubectl, true) }}:
  - task: KubectlInstaller@0
    displayName: 'Install Kubectl ${{ parameters.kubectlVersion }}'
    inputs:
      kubectlVersion: '${{ parameters.kubectlVersion }}'
      
- ${{ if eq(parameters.installHelm, true) }}:
  - task: HelmInstaller@1
    displayName: 'Install Helm ${{ parameters.helmVersion }}'
    inputs:
      helmVersionToInstall: '${{ parameters.helmVersion }}'

- task: HelmDeploy@0
  displayName: 'helm package'
  inputs:
    command: package
    chartPath: ${{ parameters.chartPath }}
    destination: '${{ parameters.artifactStagingDirectory }}/${{ parameters.artifactName }}'
    chartVersion: '${{ parameters.chartVersion }}'
    save: false
    
- publish: '${{ parameters.artifactStagingDirectory }}/${{ parameters.artifactName }}'
  artifact: '${{ parameters.artifactName }}'
  displayName: 'Publish Artifact: ${{ parameters.artifactName }}'